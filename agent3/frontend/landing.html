<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent3 AG GitHub Console</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #root {
            height: 100vh;
        }

        /* Simple spinner styles */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Style for the conversation box */
        .chat-container {
            height: calc(100vh - 400px);
            /* Adjust height for the new GitHub inputs */
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- The root element where the React component will be mounted -->
    <div id="root"></div>

    <!-- 1. Load React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is needed to compile the JSX written below -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 2. React Component (GitHub Implementation) -->
    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;

        // --- Configuration ---
        const AGENT3_GATEWAY_URL = 'http://127.0.0.1:5000/api/agent3/query';
        const MAX_RETRIES = 5;
        const BASE_DELAY_MS = 1000;

        // --- Custom Hook to Scroll to Bottom ---
        const useScrollOnNewMessage = (dependencies) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.scrollTop = ref.current.scrollHeight;
                }
            }, dependencies);
            return ref;
        };

        // --- Utility Functions (Integrated) ---

        async function fetchWithBackoff(url, options, setStatus) {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;

                    if (response.status >= 500 || response.status === 0) {
                        throw new Error(`Server or connection error. Status: ${response.status || 'N/A'}`);
                    }
                    throw new Error(`Client error: ${response.status} ${response.statusText}`);
                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) throw error;

                    const delay = BASE_DELAY_MS * (2 ** attempt);
                    setStatus(`Gateway unreachable. Retrying (${attempt + 1}/${MAX_RETRIES})...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Agent3 Panel Component (App) ---

        const Agent3Panel = () => {
            // Memory storage: array of { role: 'user' | 'agent' | 'error', content: 'text' }
            const [conversation, setConversation] = useState([
                { role: 'agent', content: "Hello. I am Agent3, the Neuroswarm Expert. I can now fetch and analyze files from your GitHub repository. Enter your credentials below and provide a file path to begin." }
            ]);

            // NEW: GitHub State
            const [githubToken, setGithubToken] = useState("");
            const [githubRepo, setGithubRepo] = useState(""); // e.g., 'https://github.com/owner/repo'
            const [githubFilePath, setGithubFilePath] = useState(""); // e.g., 'src/index.js'

            const [currentQuery, setCurrentQuery] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [statusMessage, setStatusMessage] = useState("");

            const chatRef = useScrollOnNewMessage([conversation]);

            // --- MODIFIED FUNCTION TO SEND CONVERSATION HISTORY AND GITHUB CONTEXT ---
            const getAgent3Expertise = async (history, newQuery) => {
                try {
                    // Create the full payload with the new query, history, and GITHUB details
                    const payload = {
                        query: newQuery,
                        history: history,
                        // Only send GITHUB parameters if all fields are populated
                        ...(githubToken && githubRepo && githubFilePath && {
                            github_token: githubToken,
                            github_repo: githubRepo,
                            github_filepath: githubFilePath
                        })
                    };

                    // Clear file path after sending request to prevent re-fetching on next turn
                    setGithubFilePath("");

                    const response = await fetchWithBackoff(AGENT3_GATEWAY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(payload), // Send the full payload with history and GitHub data
                    }, setStatusMessage);

                    const data = await response.json();

                    if (data.status === 'success' && data.response_content) {
                        return data.response_content;
                    } else if (data.status === 'error' && data.details) {
                        throw new Error(`Agent3 Gateway Error: ${data.details}`);
                    } else {
                        throw new Error(`Gateway Error: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    throw new Error(`Fatal error connecting to Agent3 Gateway. Details: ${error.message}`);
                }
            };

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!currentQuery.trim() || isLoading) return;

                const userQuery = currentQuery.trim();

                // 1. Add user message to temporary history and clear input
                // Note: The UI query does NOT include the file content; the server handles injection.
                const newHistory = [...conversation, { role: 'user', content: userQuery }];
                setConversation(newHistory);
                setCurrentQuery("");

                // 2. Set loading state
                setIsLoading(true);

                let fetchMessage = "Sending conversation and query to Agent3...";
                if (githubFilePath) {
                    fetchMessage = `Fetching file ${githubFilePath} from GitHub and sending to Agent3...`;
                }
                setStatusMessage(fetchMessage);

                // 3. Prepare the history array for the API call 
                const historyToSend = newHistory.map(msg => ({
                    role: msg.role === 'agent' ? 'assistant' : 'user',
                    content: msg.content
                }));

                // Remove the initial welcome message from the history sent to the API
                if (historyToSend.length > 0 && historyToSend[0].role === 'assistant') {
                    historyToSend.shift();
                }

                try {
                    // 4. Call the API with the entire conversation history and GitHub context
                    const expertAdvice = await getAgent3Expertise(historyToSend, userQuery);

                    // 5. Success: Add Agent's response to history
                    setConversation(prev => [...prev, { role: 'agent', content: expertAdvice }]);
                    setStatusMessage("Agent3 successfully responded.");

                } catch (error) {
                    // 6. Error: Add error message to history
                    setConversation(prev => [...prev, { role: 'error', content: error.message }]);
                    setStatusMessage(`Operation failed: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            }, [currentQuery, isLoading, conversation, githubToken, githubRepo, githubFilePath]);


            // --- Render Helper Components ---

            const Message = ({ message }) => {
                const isAgent = message.role === 'agent';
                const isError = message.role === 'error';

                let bgColor = isAgent ? 'bg-indigo-50' : 'bg-white';
                let roleLabel = isAgent ? 'Agent3' : 'You';
                let contentClass = isAgent ? 'text-gray-800' : 'text-gray-900';

                if (isError) {
                    bgColor = 'bg-red-100';
                    roleLabel = 'Error';
                    contentClass = 'text-red-700 font-bold';
                }

                return (
                    <div className={`p-4 rounded-xl shadow-md mb-4 ${bgColor}`}>
                        <p className={`font-bold text-sm mb-1 ${isError ? 'text-red-600' : 'text-indigo-600'}`}>{roleLabel}</p>
                        <pre className={`whitespace-pre-wrap font-mono text-xs leading-relaxed ${contentClass}`}>
                            {message.content}
                        </pre>
                    </div>
                );
            };

            const Spinner = () => (
                <div className="spinner"></div>
            );


            return (
                <div className="flex flex-col h-screen bg-gray-50 p-4 sm:p-8">
                    <header className="mb-4 pb-2 border-b border-gray-200">
                        <h1 className="text-3xl font-extrabold text-indigo-700">Agent3: GitHub Developer Assistant</h1>
                        <p className="text-sm text-gray-500">The agent now analyzes specific files from your private or public GitHub repository using the contents API (read-only).</p>
                    </header>

                    {/* GitHub Configuration Section */}
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-4 space-y-3">
                        <h2 className="text-lg font-bold text-gray-700">GitHub Configuration</h2>
                        <input
                            type="password"
                            value={githubToken}
                            onChange={(e) => setGithubToken(e.target.value)}
                            placeholder="GitHub Personal Access Token (PAT)"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition text-sm"
                        />
                        <input
                            type="text"
                            value={githubRepo}
                            onChange={(e) => setGithubRepo(e.target.value)}
                            placeholder="Repository URL (e.g., https://github.com/owner/repo)"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition text-sm"
                        />
                    </div>

                    {/* Conversation Display Area */}
                    <div ref={chatRef} className="chat-container bg-gray-100 p-4 rounded-xl mb-4 shadow-inner flex-grow">
                        {conversation.map((msg, index) => (
                            <Message key={index} message={msg} />
                        ))}
                        {isLoading && (
                            <div className="flex items-center space-x-2 p-4 rounded-xl bg-indigo-50 shadow-md">
                                <Spinner />
                                <span className="text-sm text-indigo-600">{statusMessage}</span>
                            </div>
                        )}
                    </div>

                    {/* Input Form */}
                    <form onSubmit={handleSubmit} className="p-4 bg-white rounded-xl shadow-lg border border-gray-200 mt-auto">
                        <div className="mb-3">
                            <input
                                type="text"
                                value={githubFilePath}
                                onChange={(e) => setGithubFilePath(e.target.value)}
                                placeholder="File Path to Analyze (e.g., src/main.py) - Leave blank for regular chat"
                                className="w-full p-2 border border-yellow-300 bg-yellow-50 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition text-sm"
                            />
                        </div>

                        <div className="flex space-x-3">
                            <textarea
                                rows="2"
                                value={currentQuery}
                                onChange={(e) => setCurrentQuery(e.target.value)}
                                placeholder="Ask Agent3 about the file, e.g., 'Review this code for security issues' or 'How can I refactor this function?'"
                                className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition resize-none font-mono text-sm"
                                disabled={isLoading}
                            />
                            <button
                                type="submit"
                                disabled={isLoading || !currentQuery.trim()}
                                className="flex-shrink-0 flex items-center justify-center h-full px-6 py-2 text-base font-medium rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-gray-400"
                            >
                                {isLoading ? <Spinner /> : "Send"}
                            </button>
                        </div>
                        <p className={`text-xs mt-2 font-semibold ${statusMessage.includes('Error') || statusMessage.includes('failed') ? 'text-red-600' : 'text-gray-500'}`}>
                            {statusMessage || "Ready to receive query."}
                        </p>
                    </form>
                </div>
            );
        }

        // --- Render the component ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<Agent3Panel />);
    </script>
</body>

</html>