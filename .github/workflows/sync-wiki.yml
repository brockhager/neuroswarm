name: Sync Wiki

on:
  push:
    branches: [ main ]

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone wiki repo (create if missing)
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Attempting to clone https://x-access-token:${TOKEN}@github.com/${REPO}.wiki.git"
          if git clone https://x-access-token:${TOKEN}@github.com/${REPO}.wiki.git wiki-repo; then
            echo "Cloned existing wiki repo"
          else
            echo "Wiki git repo not found; creating a fresh wiki repo and bootstrapping"
            mkdir -p wiki-repo
            cd wiki-repo
            git init
            git remote add origin https://x-access-token:${TOKEN}@github.com/${REPO}.wiki.git
            git checkout -b main || git checkout -b master
            echo "# ${REPO} Wiki" > README.md
            git add README.md
            git -c user.email='github-actions[bot]@users.noreply.github.com' -c user.name='github-actions[bot]' commit -m "chore(wiki): initial wiki creation"
            git push --set-upstream origin HEAD
            cd -
          fi

      - name: Copy wiki files
        run: |
          rm -rf wiki-repo/* || true
          # Update Last updated timestamps in each wiki source file based on last commit date
          for f in docs/wiki/*.md; do
            # Get ISO 8601 commit date for the file's last commit
            d=$(git log -1 --format=%cI -- "$f" || true)
            if [ -z "$d" ]; then
              d=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            fi
            # Replace existing Last updated line or append it
            if grep -q "^Last updated:" "$f"; then
              sed -i "s/^Last updated:.*$/Last updated: $d/" "$f"
            else
              echo -e "\nLast updated: $d" >> "$f"
            fi
          done
          cp -r docs/wiki/* wiki-repo/

      - name: Commit and push
        working-directory: wiki-repo
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No wiki changes detected"
            exit 0
          fi
          git commit -m "chore(wiki): sync docs/wiki content (automated)"
          git push

    permissions:
      contents: write