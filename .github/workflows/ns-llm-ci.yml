name: NS-LLM CI Integration & OpenAPI Validation

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'bugfix/**'
  pull_request:
    branches:
      - main
    paths:
      - 'NS-LLM/**'
      - '.github/workflows/ns-llm-ci.yml'

jobs:
  # ----------------------------------------------------------------------
  # OPS-CI-NSLLM: NS-LLM Integration Tests with OpenAPI Contract Validation
  # ----------------------------------------------------------------------
  ns_llm_integration:
    name: NS-LLM Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['20.x']

    env:
      PORT: 3015
      TEST_TIMEOUT: 180000

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '10'
    - name: Install NS-LLM Dependencies
      working-directory: ./NS-LLM
      # The repo uses pnpm for workspace installs. Use pnpm here so CI installs succeed.
      run: pnpm install --no-frozen-lockfile

    # Test 1: Health Check
    - name: üß™ Test NS-LLM Health Endpoint (Linux / macOS)
      if: matrix.os != 'windows-latest'
      working-directory: ./NS-LLM
      run: |
        # Start a short-lived prototype instance on port 5555 for health checks
        PORT=5555 node index.js &
        PROTO_PID=$!

        # Wait for /health ready on prototype
        for i in {1..30}; do
          if curl -s --fail http://127.0.0.1:5555/health >/dev/null; then
            echo "Prototype healthy"
            break
          fi
          echo "Waiting for prototype health ($i/30)"
          sleep 1
        done

        # Cleanup prototype
        kill $PROTO_PID || true

    - name: üß™ Test NS-LLM Health Endpoint (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      working-directory: ./NS-LLM
      run: |
        $env:PORT = 3015
        $proc = Start-Process -FilePath 'node' -ArgumentList 'index.js' -PassThru
        $ok = $false
        for ($i = 0; $i -lt 30; $i++) {
          try {
            $r = Invoke-WebRequest -Uri 'http://127.0.0.1:3015/health' -UseBasicParsing -TimeoutSec 3 -ErrorAction Stop
            if ($r.StatusCode -eq 200) { $ok = $true; break }
          } catch { }
          Start-Sleep -Seconds 1
        }
        if (-not $ok) {
          Write-Host 'Health check failed'
          Stop-Process -Id $proc.Id -ErrorAction SilentlyContinue
          exit 1
        }
        Stop-Process -Id $proc.Id -ErrorAction SilentlyContinue

    # Test 2: Generate Endpoint (HTTP)
    - name: üß™ Test Generate Endpoint (HTTP)
      working-directory: ./NS-LLM
      run: node tests/test-generate-http.js

    # Test 3: Generate Endpoint (Streaming)
    - name: üß™ Test Generate Endpoint (SSE Stream)
      working-directory: ./NS-LLM
      run: node tests/test-generate-stream.js

    # Test 4: Embed Endpoint
    - name: üß™ Test Embed Endpoint (Linux / macOS)
      if: matrix.os != 'windows-latest'
      working-directory: ./NS-LLM
      run: |
        # Start dedicated prototype instance for embed tests on port 5555 so shim fallback can reach it
        PORT=5555 node index.js &
        PROTO_PID=$!
        export NS_LLM_PROTOTYPE_URL=http://127.0.0.1:5555

        node tests/test-embed.js

        kill $PROTO_PID || true

    - name: üß™ Test Embed Endpoint (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      working-directory: ./NS-LLM
      run: |
        # Start prototype for embed tests on port 5555 and set NS_LLM_PROTOTYPE_URL for NativeShim
        $env:PORT = 5555
        $proc = Start-Process -FilePath 'node' -ArgumentList 'index.js' -PassThru
        $env:NS_LLM_PROTOTYPE_URL = 'http://127.0.0.1:5555'

        # run embed test
        node tests/test-embed.js

        Stop-Process -Id $proc.Id -ErrorAction SilentlyContinue

    # Test 5: Integration Test (Full Workflow)
    - name: üß™ Run Full Integration Test
      working-directory: ./NS-LLM
      run: node test-integration.js

    # Test 6: Native Inference (if applicable)
    - name: üß™ Test Native Inference Shim
      working-directory: ./NS-LLM
      run: node test-shim.js
      continue-on-error: true  # Native inference may not be available on all platforms

    # ----------------------------------------------------------------------
    # OpenAPI Contract Validation
    # ----------------------------------------------------------------------
    - name: üìã Install OpenAPI Validator
      if: matrix.os == 'ubuntu-latest'
      run: npm install -g @stoplight/spectral-cli

    - name: üìã Validate OpenAPI Specification
      if: matrix.os == 'ubuntu-latest'
      working-directory: ./NS-LLM
      run: |
        # Check OpenAPI YAML syntax (uses .spectral.yaml config)
        spectral lint openapi.yaml

    - name: üìã Verify OpenAPI Contract Matches Implementation
      if: matrix.os == 'ubuntu-latest'
      working-directory: ./NS-LLM
      run: |
        # Start prototype server in background (no native binary required)
        PORT=3015 node index.js &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 5
        
        # Test endpoints defined in OpenAPI spec
        echo "Testing /health endpoint..."
        curl -f http://localhost:3015/health || exit 1
        
        echo "Testing /api/embed endpoint..."
        curl -f http://localhost:3015/api/embed -X POST \
          -H "Content-Type: application/json" \
          -d '{"text":"test"}' || exit 1
        
        # Cleanup
        kill $SERVER_PID
        echo "‚úÖ All OpenAPI endpoints validated"

    # ----------------------------------------------------------------------
    # Artifact Checks (Embeddings & Response Quality)
    # ----------------------------------------------------------------------
    - name: üîç Verify Embedding Dimensions
      if: matrix.os == 'ubuntu-latest'
      working-directory: ./NS-LLM
      run: |
        node --input-type=module -e "
        import { spawn } from 'child_process';
        
        const server = spawn('node', ['index.js']);
        
        setTimeout(async () => {
          try {
            const res = await fetch('http://localhost:3015/api/embed', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: 'test embedding' })
            });
            const data = await res.json();
            
            if (!data.embedding || !Array.isArray(data.embedding)) {
              console.error('‚ùå Invalid embedding format');
              process.exit(1);
            }
            
            console.log('‚úÖ Embedding dimension:', data.embedding.length);
            if (data.embedding.length === 0) {
              console.error('‚ùå Empty embedding vector');
              process.exit(1);
            }
            
            server.kill();
            process.exit(0);
          } catch (err) {
            console.error('‚ùå Embedding test failed:', err.message);
            server.kill();
            process.exit(1);
          }
        }, 5000);
        "

    - name: üîç Verify Generate Response Quality
      if: matrix.os == 'ubuntu-latest'
      working-directory: ./NS-LLM
      run: |
        node --input-type=module -e "
        import { spawn } from 'child_process';
        
        const server = spawn('node', ['index.js']);
        
        setTimeout(async () => {
          try {
            const res = await fetch('http://localhost:3015/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: 'Hello world', max_tokens: 50 })
            });
            const data = await res.json();
            
            if (!data.text || typeof data.text !== 'string') {
              console.error('‚ùå Invalid response format');
              process.exit(1);
            }
            
            if (data.text.trim().length === 0) {
              console.error('‚ùå Empty response');
              process.exit(1);
            }
            
            console.log('‚úÖ Generated text length:', data.text.length);
            server.kill();
            process.exit(0);
          } catch (err) {
            console.error('‚ùå Generate test failed:', err.message);
            server.kill();
            process.exit(1);
          }
        }, 5000);
        "

    # ----------------------------------------------------------------------
    # Performance Benchmarking
    # ----------------------------------------------------------------------
    - name: üìä Run Performance Benchmark
      if: matrix.os == 'ubuntu-latest'
      working-directory: ./NS-LLM
      run: node benchmark.js
      continue-on-error: true  # Benchmarks shouldn't fail CI

    - name: ‚úÖ Summary
      if: always()
      run: |
        echo "NS-LLM CI Tests Complete on ${{ matrix.os }}"
        echo "Node.js version: ${{ matrix.node-version }}"
