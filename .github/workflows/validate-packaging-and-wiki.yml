name: Validate Packaging & Wiki Sync

on:
  workflow_dispatch:

jobs:
  validate:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            os: linux
          - runner: macos-latest
            os: macos
          - runner: windows-latest
            os: win
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@8

      - name: Install dependencies
        run: pnpm install -w

      - name: Build installers for ${{ matrix.os }}
        run: |
          set -ex
          pnpm -C neuroswarm package:bins -- --os ${{ matrix.os }}

      - name: List generated artifacts
        run: |
          set -ex
          ls -la neuroswarm/dist || true

      - name: Validate run scripts point to server.js
        run: |
          node neuroswarm/scripts/check-run-scripts.mjs

      - name: Verify node entry files are startup files
        run: |
          node neuroswarm/scripts/verifyEntry.mjs neuroswarm/ns-node/server.js ns
          node neuroswarm/scripts/verifyEntry.mjs neuroswarm/gateway-node/server.js gw
          node neuroswarm/scripts/verifyEntry.mjs neuroswarm/vp-node/server.js vp

      - name: Validate VP packaging correctness
        run: |
          node neuroswarm/scripts/check-vp-packaging.mjs

      - name: Validate NS packaging correctness
        run: |
          node neuroswarm/scripts/check-ns-packaging.mjs

      - name: Validate Gateway packaging correctness
        run: |
          node neuroswarm/scripts/check-gateway-packaging.mjs

      - name: Validate Home.md is present and not empty
        run: |
          set -e
          if [ -f neuroswarm/docs/wiki/Home.md ]; then
            test -s neuroswarm/docs/wiki/Home.md || (echo "Home.md in docs is empty" && exit 1)
          elif [ -f neuroswarm/wiki/Home.md ]; then
            test -s neuroswarm/wiki/Home.md || (echo "Home.md in wiki is empty" && exit 1)
          else
            echo "Home.md not found in neuroswarm/docs/wiki or neuroswarm/wiki" && exit 1
          fi

      - name: Cross-platform ZIP contents check (Node)
        run: |
          node neuroswarm/scripts/check-zip-contents.mjs

      - name: Validate node startup logs by launching servers (CI)
        run: |
          node neuroswarm/scripts/check-startup-logs.mjs

      - name: Verify run scripts included in ZIP artifacts (Unix runners)
        if: runner.os != 'Windows'
        run: |
          set -e
          for z in neuroswarm/dist/*.zip; do
            echo "Checking $z for run scripts"
            if unzip -l "$z" | grep -q "run-ns.bat\|run-ns.sh"; then
              echo "Found ns run scripts in $z";
            else
              echo "ERROR: ns run scripts missing from $z"; exit 1;
            fi
            if unzip -l "$z" | grep -q "run-gateway.bat\|run-gateway.sh"; then
              echo "Found gateway run scripts in $z";
            else
              echo "ERROR: gateway run scripts missing from $z"; exit 1;
            fi
            if unzip -l "$z" | grep -q "run-vp.bat\|run-vp.sh"; then
              echo "Found vp run scripts in $z";
            else
              echo "ERROR: vp run scripts missing from $z"; exit 1;
            fi
          done

      - name: Verify run scripts included in ZIP artifacts (Windows runner)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Get-ChildItem neuroswarm\dist -Filter *.zip | ForEach-Object {
            $zip = $_.FullName
            Write-Host "Checking $zip for run scripts"
            $tmp = Join-Path $env:TEMP ([System.Guid]::NewGuid().ToString())
            New-Item -ItemType Directory -Force -Path $tmp | Out-Null
            Expand-Archive -Path $zip -DestinationPath $tmp -Force
            if (-Not (Test-Path (Join-Path $tmp 'run-ns.bat') -PathType Leaf -ErrorAction SilentlyContinue -or Test-Path (Join-Path $tmp 'run-ns.sh'))) { throw "ns run script missing in $zip" }
            if (-Not (Test-Path (Join-Path $tmp 'run-gateway.bat') -PathType Leaf -ErrorAction SilentlyContinue -or Test-Path (Join-Path $tmp 'run-gateway.sh'))) { throw "gateway run script missing in $zip" }
            if (-Not (Test-Path (Join-Path $tmp 'run-vp.bat') -PathType Leaf -ErrorAction SilentlyContinue -or Test-Path (Join-Path $tmp 'run-vp.sh'))) { throw "vp run script missing in $zip" }
            Remove-Item -Path $tmp -Recurse -Force
          }

      - name: Validate archives contain start scripts and binaries
        run: |
          set -ex
          for z in neuroswarm/dist/*.zip; do
            echo "Checking $z";
            if [[ "${{ matrix.os }}" == "win" ]]; then
              powershell -NoProfile -Command "Write-Host 'Listing archive via PowerShell'; Expand-Archive -Path $z -DestinationPath ./tmp-unzip -Force; Get-ChildItem -Recurse -Path ./tmp-unzip"
            else
              unzip -l $z
            fi
          done

      - name: Run docs sync dry-run
        run: |
          node neuroswarm/scripts/pushDocsToWiki.mjs --dry-run

      - name: Test pushDocsToWiki blocks Home.md in CI
        run: |
          node neuroswarm/scripts/test-pushDocsToWiki-home-block.mjs

      - name: Test migrate-kb-to-wiki blocks Home.md in CI
        run: |
          node neuroswarm/scripts/test-migrate-kb-block-home.mjs

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: validate-installers-${{ matrix.os }}
          path: neuroswarm/dist/*.zip
