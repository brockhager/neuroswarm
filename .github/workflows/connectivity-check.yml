name: Connectivity Check

on:
  workflow_dispatch:

jobs:
  connectivity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (pnpm)
        run: |
          npm install -g pnpm@8
          pnpm install -w

      - name: Start ns-node
        run: |
          sed -n '1,120p' neuroswarm/ns-node/server.js > /dev/null
          node neuroswarm/ns-node/server.js > ns.log 2> ns.err & echo $! > ns.pid

      - name: Wait for ns-node health
        run: |
          set -ex
          for i in 1 2 3 4 5; do
            if curl --silent --fail http://localhost:3000/health; then exit 0; fi
            sleep 1
          done
          echo 'ns-node failed to become healthy' && exit 1

      - name: Start gateway
        env:
          NS_CHECK_EXIT_ON_FAIL: 'false'
          NS_NODE_URL: 'http://localhost:3000'
        run: |
          set -e
          node neuroswarm/gateway-node/server.js > gw.log 2> gw.err & echo $! > gw.pid

      - name: Wait for gateway health
        run: |
          set -ex
          for i in 1 2 3 4 5; do
            if curl --silent --fail http://localhost:8080/health; then exit 0; fi
            sleep 1
          done
          echo 'gateway failed to become healthy' && exit 1

      - name: Run connectivity script (CI) + save results
        run: |
          node neuroswarm/scripts/checkNodeConnectivityClean.mjs --ns http://localhost:3000 --gateway http://localhost:8080 --timeout 2000 > connectivity.json || true

      - name: Parse connectivity results and comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'connectivity.json';
            if (!fs.existsSync(path)) { console.log('No connectivity JSON produced'); return; }
            const j = JSON.parse(fs.readFileSync(path, 'utf8'));
            const checked = j.checked || {};
            const results = j.results || [];
            const failEntries = results.filter(r => { const v = Object.values(r)[0]; return v && v.ok === false; });
            if (failEntries.length) {
              let body = ':x: Connectivity checks failed for the following endpoints\n\n';
              for (const f of failEntries) {
                const k = Object.keys(f)[0];
                body += `- **${k}**: ${JSON.stringify(f[k])}\n`;
              }
              const prNumber = context.payload.pull_request.number;
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });
              throw new Error('Connectivity checks failed; see PR comment for details.');
            } else {
              console.log('All connectivity checks passed.');
            }
      - name: Upload connectivity results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connectivity-results
          path: connectivity.json

      - name: Upload node logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: node-logs
          path: |
            ns.log
            ns.err
            gw.log
            gw.err

      - name: Teardown
        if: always()
        run: |
          if [ -f ns.pid ]; then kill $(cat ns.pid) || true; fi
          if [ -f gw.pid ]; then kill $(cat gw.pid) || true; fi
