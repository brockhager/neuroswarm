# Protect Wiki Home Page
# ping: 2025-11-18 23:35:00 UTC
 # Last ping: 2025-11-18

on:
  workflow_dispatch:
  schedule:
    # Run every 15 minutes to detect and restore Home.md if compromised
    - cron: '*/15 * * * *'
  push:
    branches:
      - main
      - master
    paths:
      - 'neuroswarm/wiki/Home.md'
      - 'neuroswarm/docs/wiki/Home.md'
      - '.github/workflows/protect-wiki-home.yml'

jobs:
  protect-home:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check source Home.md is valid
        run: |
          set -e
          if [ -f neuroswarm/wiki/Home.md ]; then
            test -s neuroswarm/wiki/Home.md || {
              echo "ERROR: neuroswarm/wiki/Home.md is empty"
              exit 1
            }
          elif [ -f neuroswarm/docs/wiki/Home.md ]; then
            test -s neuroswarm/docs/wiki/Home.md || {
              echo "ERROR: neuroswarm/docs/wiki/Home.md is empty"
              exit 1
            }
          else
            echo "ERROR: Home.md not found in neuroswarm/wiki or neuroswarm/docs/wiki"
            exit 1
          fi
          echo "âœ“ Source Home.md is valid"

      - name: Validate only Download.md contains direct download links
        run: |
          node neuroswarm/scripts/check-download-links.mjs

      - name: Restore wiki Home.md if needed
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node neuroswarm/scripts/restore-wiki-home.mjs

      - name: Verify restoration worked
        if: failure()
        run: |
          echo "::error::Wiki Home.md restoration failed - manual intervention required"
          exit 1

      - name: Notify maintainers if wiki restored
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e
          TMPDIR="neuroswarm/tmp/wiki-home-check"
          if [ -d "$TMPDIR" ]; then
            cd "$TMPDIR"
            if git log -1 --pretty=%B | grep -q "Restore Home.md content"; then
              echo "Home.md restored in wiki; creating issue to notify maintainers"
              curl -s -H "Authorization: token $GH_PAT" -H "Accept: application/vnd.github+json" \
                -X POST https://api.github.com/repos/${{ github.repository }}/issues \
                -d '{"title":"Wiki Home.md restored by automation","body":"The wiki Home.md was detected missing and has been automatically restored by CI. Please review the restoration and the content."}'
            fi
          fi

      - name: Report last wiki commit (for forensics)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e
          TMPDIR="neuroswarm/tmp/wiki-home-check"
          if [ -d "$TMPDIR" ]; then
            cd "$TMPDIR"
            last=$(git log -1 --pretty=format:'%H|%an|%ae|%s')
            echo "Last wiki commit: $last"
          else
            echo "TMPDIR not found: $TMPDIR"
          fi
