name: PR Checklist - Admin Node CI

on:
  pull_request:
    paths:
      - 'admin-node/**'
      - '.github/**'
      - 'docs/**'

permissions:
  contents: write
  pages: write

jobs:
  run-pr-checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('admin-node/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-ms-playwright-

      - name: Run admin-node PR checklist (Bash)
        run: |
          chmod +x ./admin-node/scripts/run-pr-checklist.sh
          ./admin-node/scripts/run-pr-checklist.sh

      - name: Upload Playwright report (playwright-report)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: admin-node/playwright-report

      - name: Upload Playwright test-results (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: admin-node/test-results

      - name: Upload Playwright trace and screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-screenshots
          path: |
            admin-node/**/trace
            admin-node/**/screenshot*
            admin-node/**/screenshots

      - name: Comment PR with Playwright report link & summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const resp = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: runId });
            const artifact = resp.data.artifacts.find(a => a.name === 'playwright-report');
            const resultsArt = resp.data.artifacts.find(a => a.name === 'playwright-test-results');
            const uiUrl = artifact ? `https://github.com/${owner}/${repo}/suites/${runId}/artifacts/${artifact.id}` : null;
            const downloadUrl = artifact ? artifact.archive_download_url : null;
            const resultsDownload = resultsArt ? resultsArt.archive_download_url : null;
            const summaryPath = 'admin-node/playwright-results/summary.json';
            let summary = null;
            if (fs.existsSync(summaryPath)) {
              try { summary = JSON.parse(fs.readFileSync(summaryPath)); } catch(e) { summary = null; }
            }
            let summaryLine = '';
            if (summary) {
              summaryLine = `**Summary**: ${summary.passed} passed, ${summary.failed} failed, ${summary.skipped} skipped`;
            } else {
              summaryLine = 'Playwright summary not available.';
            }
            const prNumber = context.payload.pull_request.number;
            const parts = [`:robot: Playwright artifacts uploaded for this run.`, summaryLine];
            if (uiUrl) parts.push(`- [View HTML Report](${uiUrl})`);
            if (downloadUrl) parts.push(`- [Download HTML Report (zip)](${downloadUrl})`);
            if (resultsDownload) parts.push(`- [Download Test Results (zip)](${resultsDownload})`);
            const commentBody = parts.join('\n');
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: commentBody });

    timeout-minutes: 30

  deploy-to-pages:
    runs-on: ubuntu-latest
    needs: run-pr-checklist
    name: Deploy Playwright HTML report to GitHub Pages
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download Playwright report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
        continue-on-error: true

      - name: Prepare site folder
        run: |
          rm -rf temp-site || true
          mkdir -p temp-site/playwright-reports/${{ github.run_id }}
          if [ -d "playwright-report" ]; then
            cp -r playwright-report/* temp-site/playwright-reports/${{ github.run_id }} || true
          fi

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Clone or create gh-pages branch
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Cloning or creating gh-pages branch"
          git clone https://x-access-token:${TOKEN}@github.com/${REPO}.git gh-pages-repo
          cd gh-pages-repo
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
            git pull origin gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . || true
            mkdir -p playwright-reports
            echo "<html><body><h1>Playwright Reports</h1></body></html>" > index.html
            git add index.html
            git commit -m "chore(pages): init gh-pages branch"
            git push --set-upstream origin gh-pages
          fi
          cd ..

      - name: Copy report and build meta
        env:
          RUN_ID: ${{ github.run_id }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
        run: |
          set -e
          mkdir -p temp-site/playwright-reports/${RUN_ID}
          if [ -d "playwright-report" ]; then
            cp -r playwright-report/* temp-site/playwright-reports/${RUN_ID}/ || true
          fi
          if [ -f "admin-node/playwright-results/summary.json" ]; then
            cp admin-node/playwright-results/summary.json temp-site/playwright-reports/${RUN_ID}/summary.json || true
          fi
          PR_NUMBER=${PR_NUMBER:-}
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          if [ -f "temp-site/playwright-reports/${RUN_ID}/summary.json" ]; then
            passed=$(jq -r '.passed' temp-site/playwright-reports/${RUN_ID}/summary.json)
            failed=$(jq -r '.failed' temp-site/playwright-reports/${RUN_ID}/summary.json)
            skipped=$(jq -r '.skipped' temp-site/playwright-reports/${RUN_ID}/summary.json)
            echo "{\"runId\": \"${RUN_ID}\", \"prNumber\": \"${PR_NUMBER}\", \"timestamp\": \"${TIMESTAMP}\", \"passed\": ${passed}, \"failed\": ${failed}, \"skipped\": ${skipped}}" > temp-site/playwright-reports/${RUN_ID}/meta.json
          else
            echo "{\"runId\": \"${RUN_ID}\", \"prNumber\": \"${PR_NUMBER}\", \"timestamp\": \"${TIMESTAMP}\"}" > temp-site/playwright-reports/${RUN_ID}/meta.json
          fi

      - name: Merge and purge old reports on gh-pages
        env:
          KEEP_LAST: 30
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          cd gh-pages-repo
          mkdir -p playwright-reports
          cp -r ../temp-site/playwright-reports/* playwright-reports/ || true
          echo "Purging old reports, keeping last $KEEP_LAST"
          cd playwright-reports
          ls -1t | awk -v keep=$KEEP_LAST 'NR>keep{print $0}' | xargs -r rm -rf || true
          cd ..
          # Rebuild index.html using meta.json
          echo "<html><head><meta charset=\"utf-8\"><title>Playwright Reports</title></head><body><h1>Playwright Reports</h1><ul>" > index.html
          for d in $(ls -1t playwright-reports); do
            if [ -d "playwright-reports/$d" ]; then
              meta="playwright-reports/$d/meta.json"
              if [ -f "$meta" ]; then
                title=$(jq -r '.runId' $meta)
                pr=$(jq -r '.prNumber' $meta)
                ts=$(jq -r '.timestamp' $meta)
              else
                title=$d
                pr=""
                ts=""
              fi
              echo "<li><a href=\"playwright-reports/$d/index.html\">$title</a> - PR: $pr - $ts</li>" >> index.html
            fi
          done
          echo "</ul></body></html>" >> index.html
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to gh-pages"
          else
            git commit -m "chore(pages): deploy playwright report and update index"
            git push
          fi

      - name: Comment PR with GitHub Pages report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const prNumber = context.payload.pull_request.number;
            const pagesUrl = `https://${owner}.github.io/${repo}/playwright-reports/${runId}/index.html`;
            const body = `:robot: Playwright HTML report published to GitHub Pages: ${pagesUrl}`;
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
