name: Router API - Apply Schema Migration

on:
  push:
    branches:
      - main
    paths:
      - 'router-api/**'
      - 'router-api/migrations/**'
  workflow_dispatch:

jobs:
  apply_migration:
    runs-on: ubuntu-latest
    # Only run if staging DB secrets are configured
    if: secrets.STAGING_PG_HOST != '' && secrets.STAGING_PG_USER != '' && secrets.STAGING_PG_PASSWORD != '' && secrets.STAGING_PG_DATABASE != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Execute migration runner (with pre-flight check)
        env:
          PGHOST: ${{ secrets.STAGING_PG_HOST }}
          PGPORT: ${{ secrets.STAGING_PG_PORT }}
          PGUSER: ${{ secrets.STAGING_PG_USER }}
          PGPASSWORD: ${{ secrets.STAGING_PG_PASSWORD }}
          PGDATABASE: ${{ secrets.STAGING_PG_DATABASE }}
        run: |
          set -euo pipefail
          echo "Checking migration environment variables (secrets must be configured)"
          # Print availability, not values
          if [ -z "${PGHOST:-}" ] || [ -z "${PGUSER:-}" ] || [ -z "${PGPASSWORD:-}" ] || [ -z "${PGDATABASE:-}" ]; then
            echo "ERROR: Missing required DB secrets. The migration job requires STAGING_PG_HOST, STAGING_PG_USER, STAGING_PG_PASSWORD and STAGING_PG_DATABASE to be configured as repository secrets."
            echo "If you intend to run migrations in CI you must add the appropriate secrets to this repository or use the run-migrations.sh runner with a self-hosted/test database."
            echo "PGHOST present: ${PGHOST:+YES}${PGHOST:-NO}"
            exit 2
          fi

          echo "All required DB env vars present (masked). Running migrations using router-api/migrations/run-migrations.sh"
          chmod +x router-api/migrations/run-migrations.sh
          ./router-api/migrations/run-migrations.sh
          echo "âœ… Database migrations completed successfully."

      # Deployment steps may follow here in your deploy job
      # - name: Build and Deploy Router API Service
      #   uses: some-deploy-action
      #   with: ...
