name: Security Checks

permissions:
  security-events: write
  actions: read
  contents: read

on:
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript, typescript

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      if: github.event_name == 'pull_request'

    - name: Run security audit
      run: pnpm audit --audit-level moderate
      working-directory: ./website
      continue-on-error: true

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Debug - list commits (signature status)
      run: |
        set -euo pipefail
        if [ -n "${{ github.event.before || '' }}" ]; then
          RANGE="${{ github.event.before }}..${{ github.sha }}"
        else
          RANGE="HEAD~50..HEAD"
        fi
        echo "Inspecting commits in range: $RANGE"
        git --no-pager log --pretty=format:'%H %G? %an %s' $RANGE > commit-status.txt || true
        echo "All commits in range (status, sha, author, subject):"
        cat commit-status.txt || true
        echo "\nUnsigned commits (status = N):"
        awk '$2 == "N" {print $0}' commit-status.txt || true
        echo "\nCommits with bad/unknown signatures (B/U):"
        awk '$2 == "B" || $2 == "U" {print $0}' commit-status.txt || true

    - name: Comment on PR with unsigned commits & remediation
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = 'commit-status.txt';
          if (!fs.existsSync(path)) { core.info('No commit-status.txt found'); return; }
          const lines = fs.readFileSync(path, 'utf8').trim().split(/\r?\n/).filter(Boolean);

    steps:
    - name: Send security alert
      run: |
        echo "ðŸš¨ Security check failed on main branch"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Check the security scan results above for details"
        # Add your notification logic here (Slack, email, etc.)