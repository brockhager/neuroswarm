name: Security Checks

permissions:
  security-events: write
  actions: read
  contents: read

on:
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript, typescript

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      if: github.event_name == 'pull_request'

    - name: Run security audit
      run: pnpm audit --audit-level moderate
      working-directory: ./website
      continue-on-error: true

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Debug - list commits (signature status)
      run: |
        set -euo pipefail
        if [ -n "${{ github.event.before || '' }}" ]; then
          RANGE="${{ github.event.before }}..${{ github.sha }}"
        else
          RANGE="HEAD~50..HEAD"
        fi
        echo "Inspecting commits in range: $RANGE"
        git --no-pager log --pretty=format:'%H %G? %an %s' $RANGE > commit-status.txt || true
        echo "All commits in range (status, sha, author, subject):"
        cat commit-status.txt || true
        echo "\nUnsigned commits (status = N):"
        awk '$2 == "N" {print $0}' commit-status.txt || true
        echo "\nCommits with bad/unknown signatures (B/U):"
        awk '$2 == "B" || $2 == "U" {print $0}' commit-status.txt || true

    - name: Comment on PR with unsigned commits & remediation
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = 'commit-status.txt';
          if (!fs.existsSync(path)) { core.info('No commit-status.txt found'); return; }
          const lines = fs.readFileSync(path, 'utf8').trim().split(/\r?\n/).filter(Boolean);
          const unsigned = lines.filter(l => l.split(/\s+/)[1] === 'N');
          if (unsigned.length === 0) { core.info('No unsigned commits found'); return; }
          // Build a helpful remediation message
          const offending = unsigned.map(l => `- \\`${l.split(/\\s+/)[0]}\\` by ${l.split(/\\s+/)[2]} ‚Äî ${l.split(/\\s+/).slice(3).join(' ')}`).join('\n');
          const baseSha = context.payload.pull_request && context.payload.pull_request.base && context.payload.pull_request.base.sha ? context.payload.pull_request.base.sha : '${{ github.event.before }}';
          const headSha = context.payload.pull_request && context.payload.pull_request.head && context.payload.pull_request.head.sha ? context.payload.pull_request.head.sha : '${{ github.sha }}';
          const body = `‚ö†Ô∏è Security check found unsigned commits in this PR.\n\n**Offending commits:**\n${offending}\n\n**Suggested fixes (pick one):**\n1. Re-sign the commit(s) locally (rewrites history):\n   ```bash\n   # Re-sign all commits between ${baseSha} and ${headSha}\n   git fetch --all --prune\n   git rebase --exec 'git commit --amend --no-edit -S' -i ${baseSha}\n   git push --force-with-lease origin ${context.payload.pull_request.head.ref}\n   ```\n2. Re-sign selected commit(s) interactively:\n   ```bash\n   git checkout ${context.payload.pull_request.head.ref}\n   git rebase -i ${baseSha}\n   # mark offending commits as 'edit' and run for each: git commit --amend --no-edit -S; git rebase --continue\n   git push --force-with-lease origin ${context.payload.pull_request.head.ref}\n   ```\n\nIf you need help configuring GPG / signing keys on your machine, ask here and I can provide step-by-step instructions for Windows / macOS / Linux.`;
          const prNumber = context.payload.pull_request && context.payload.pull_request.number ? context.payload.pull_request.number : null;
          if (prNumber) {
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });
          } else {
            core.info(body);
          }

    - name: Fail on unsigned commits (push)
      if: github.event_name == 'push'
      run: |
        set -euo pipefail
        if [ ! -f commit-status.txt ]; then
          echo "No commit-status.txt available; run debug listing first";
          exit 1;
        fi
        unsigned=$(awk '$2=="N" {print $0}' commit-status.txt || true)
        if [ -n "$unsigned" ]; then
          echo "Unsigned commits detected in push range:";
          echo "$unsigned";
          echo "\nRe-sign those commits locally and force-push to fix the PR/branch.";
          exit 1
        else
          echo "All commits signed; no unsigned commits found.";
        fi

    - name: Verify commit signatures
      if: github.event_name == 'push'
      run: |
        echo "Verifying commit signatures..."
        if git log --oneline --show-signature ${{ github.event.before }}..${{ github.sha }} | grep -q "gpg: Signature made"; then
          echo "‚úÖ All commits are signed"
        else
          echo "‚ùå Unsigned commits detected"
          exit 1
        fi
 
  compliance-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check license compliance
      run: |
        # Check that all source files have appropriate license headers
        find src website -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | head -10 | xargs grep -L "Copyright" || echo "Some files missing copyright headers"

    - name: Validate CODEOWNERS
      run: |
        if [ -f .github/CODEOWNERS ]; then
          echo "‚úÖ CODEOWNERS file exists"
        else
          echo "‚ùå CODEOWNERS file missing"
          exit 1
        fi

    - name: Check security documentation
      run: |
        required_files=("docs/SECURITY.md" "docs/GOVERNANCE.md")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done

  notify-security:
    needs: [security-scan, compliance-check]
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'

    steps:
    - name: Send security alert
      run: |
        echo "üö® Security check failed on main branch"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Check the security scan results above for details"
        # Add your notification logic here (Slack, email, etc.)