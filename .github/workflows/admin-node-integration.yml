name: Admin Node Integration Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: write
  pages: write

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    name: Run integration and unit tests for admin-node
    strategy:
      matrix:
        node-version: [18, 20, 22]
        chain-mode: [simulated, real]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: ./admin-node

      - name: Validate npm ci used the lockfile
        run: |
          # Ensure package-lock.json wasn't modified by npm ci, to detect lockfile drift
          git diff --exit-code package-lock.json || (echo "Lockfile changed after npm ci" && exit 1)
        working-directory: ./admin-node

      - name: Run tests (unit + integration)
        run: |
          # Simulate different chain modes to catch edge cases
          if [ "${{ matrix.chain-mode }}" = "simulated" ]; then
            export SIMULATED_CHAIN=true;
          else
            export SIMULATED_CHAIN=false;
          fi

          NODE_ENV=test DISCORD_BOT_TOKEN="" PORT=0 npm test --silent
        working-directory: ./admin-node

  e2e-tests:
    runs-on: ubuntu-latest
    needs: integration-tests
    name: Run Playwright e2e tests for admin-node
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: ./admin-node

      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        working-directory: ./admin-node

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('admin-node/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-ms-playwright-

      - name: Validate Playwright browsers installed
        run: |
          # Confirm browsers are installed by listing them
          npx playwright show-browsers --with-deps | tee browsers.txt
          if ! grep -q "chromium" browsers.txt; then echo "Chromium not found" && exit 1; fi
          if ! grep -q "firefox" browsers.txt; then echo "Firefox not found" && exit 1; fi
          if ! grep -q "webkit" browsers.txt; then echo "Webkit not found" && exit 1; fi
        working-directory: ./admin-node

      - name: Seed Governance Timeline for E2E
        run: |
          node scripts/seed-e2e-timeline.js
        working-directory: ./admin-node

      - name: Run e2e tests
        run: |
          # Run Playwright tests producing both JSON (results) and HTML report.
          mkdir -p playwright-results
          set +e
          NODE_ENV=test DISCORD_BOT_TOKEN="" npm run e2e:ci -- --workers=1 -- --reporter=json > playwright-results/results.json
          E2E_EXIT_CODE=$?
          set -e
          # Generate HTML report (if Playwright produced report directory)
          npx playwright show-report || true
          # Preserve test exit code to fail build if tests failed
          exit ${E2E_EXIT_CODE}
        working-directory: ./admin-node

      - name: Compute Playwright test summary
        run: |
          mkdir -p playwright-results
          node -e "const fs=require('fs'); const path='playwright-results/results.json'; if(!fs.existsSync(path)){console.log('No JSON results file to parse.'); process.exit(0);} const r=JSON.parse(fs.readFileSync(path)); let passed=0, failed=0, skipped=0; function walk(s){ if(s.tests){ s.tests.forEach(t=>{ if(t.status==='passed') passed++; else if(t.status==='failed') failed++; else if(t.status==='skipped') skipped++; }) } if(s.suites) s.suites.forEach(walk); } walk(r); const sum={passed,failed,skipped}; fs.writeFileSync('playwright-results/summary.json', JSON.stringify(sum)); console.log(JSON.stringify(sum));"
        working-directory: ./admin-node

      - name: Generate Playwright HTML report (if test produced results)
        if: always()
        run: |
          # Ensure the HTML report exists (Playwright creates a report directory under admin-node)
          if [ -d "admin-node/playwright-report" ]; then
            echo "playwright-report exists";
          else
            echo "No playwright html report found; attempting to show any existing report";
            cd admin-node; npx playwright show-report || true; cd -;
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: admin-node/playwright-report

      - name: Upload Playwright test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: |
            admin-node/test-results
            admin-node/playwright-results

      - name: Upload Playwright trace and screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-screenshots
          path: |
            admin-node/**/trace
            admin-node/**/screenshot*
            admin-node/**/screenshots

      - name: Comment PR with Playwright report and summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const resp = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: runId });
            const report = resp.data.artifacts.find(a => a.name === 'playwright-report');
            const resultsArt = resp.data.artifacts.find(a => a.name === 'playwright-test-results');
            const reportUiUrl = report ? `https://github.com/${owner}/${repo}/suites/${runId}/artifacts/${report.id}` : null;
            const reportDownload = report ? report.archive_download_url : null;
            const resultsDownload = resultsArt ? resultsArt.archive_download_url : null;
            const summaryPath = 'admin-node/playwright-results/summary.json';
            let summary = null;
            if (fs.existsSync(summaryPath)) {
              try { summary = JSON.parse(fs.readFileSync(summaryPath)); } catch(e){ summary = null; }
            }
            let summaryLine = '';
            if (summary) {
              summaryLine = `**Summary**: ${summary.passed} passed, ${summary.failed} failed, ${summary.skipped} skipped`;
            } else {
              summaryLine = 'Playwright summary not available.';
            }
            const prNumber = context.payload.pull_request.number;
            const bodyParts = [`:robot: Playwright artifacts uploaded for this run.`, summaryLine];
            if (reportUiUrl) bodyParts.push(`- [View HTML Report](${reportUiUrl})`);
            if (reportDownload) bodyParts.push(`- [Download HTML Report (zip)](${reportDownload})`);
            if (resultsDownload) bodyParts.push(`- [Download Test Results (zip)](${resultsDownload})`);
            const commentBody = bodyParts.join('\n');
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: commentBody });

  deploy-to-pages:
    runs-on: ubuntu-latest
    needs: e2e-tests
    name: Deploy Playwright HTML report to GitHub Pages
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download Playwright report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
        continue-on-error: true

      - name: Prepare site folder
        run: |
          rm -rf temp-site || true
          mkdir -p temp-site/playwright-reports/${{ github.run_id }}
          if [ -d "playwright-report" ]; then
            cp -r playwright-report/* temp-site/playwright-reports/${{ github.run_id }} || true
          fi

      - name: Clone or create gh-pages branch
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Cloning or creating gh-pages branch"
          git clone https://x-access-token:${TOKEN}@github.com/${REPO}.git gh-pages-repo
          cd gh-pages-repo
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
            git pull origin gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . || true
            mkdir -p playwright-reports
            echo "<html><body><h1>Playwright Reports</h1></body></html>" > index.html
            git add index.html
            git commit -m "chore(pages): init gh-pages branch"
            git push --set-upstream origin gh-pages
          fi
          cd ..

      - name: Copy report and build meta
        env:
          RUN_ID: ${{ github.run_id }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
          TIMESTAMP: ""
        run: |
          set -e
          mkdir -p temp-site/playwright-reports/${RUN_ID}
          if [ -d "playwright-report" ]; then
            cp -r playwright-report/* temp-site/playwright-reports/${RUN_ID}/ || true
          fi
          # copy summary if present
          if [ -f "admin-node/playwright-results/summary.json" ]; then
            cp admin-node/playwright-results/summary.json temp-site/playwright-reports/${RUN_ID}/summary.json || true
          fi
          # Write meta.json safely using echo
          PR_NUMBER=${PR_NUMBER:-}
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          # If summary.json exists, include pass/fail counts in meta.json
          if [ -f "temp-site/playwright-reports/${RUN_ID}/summary.json" ]; then
            passed=$(jq -r '.passed' temp-site/playwright-reports/${RUN_ID}/summary.json)
            failed=$(jq -r '.failed' temp-site/playwright-reports/${RUN_ID}/summary.json)
            skipped=$(jq -r '.skipped' temp-site/playwright-reports/${RUN_ID}/summary.json)
            echo "{\"runId\": \"${RUN_ID}\", \"prNumber\": \"${PR_NUMBER}\", \"timestamp\": \"${TIMESTAMP}\", \"passed\": ${passed}, \"failed\": ${failed}, \"skipped\": ${skipped}}" > temp-site/playwright-reports/${RUN_ID}/meta.json
          else
            echo "{\"runId\": \"${RUN_ID}\", \"prNumber\": \"${PR_NUMBER}\", \"timestamp\": \"${TIMESTAMP}\"}" > temp-site/playwright-reports/${RUN_ID}/meta.json
          fi

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Merge and purge old reports on gh-pages
        env:
          KEEP_LAST: 30
        run: |
          set -e
          cd gh-pages-repo
          # Ensure playwright-reports exists
          mkdir -p playwright-reports
          # Copy new report(s)
          cp -r ../temp-site/playwright-reports/* playwright-reports/ || true
          # Purge older runs - keep the most recent $KEEP_LAST by directory mtime
          echo "Purging old reports, keeping last $KEEP_LAST"
          cd playwright-reports
          # list dirs by modification time and skip the first $KEEP_LAST
          ls -1t | awk -v keep=$KEEP_LAST 'NR>keep{print $0}' | xargs -r rm -rf || true
          cd ..
          # Rebuild index.html
          echo "<html><head><meta charset=\"utf-8\"><title>Playwright Reports</title></head><body><h1>Playwright Reports</h1><ul>" > index.html
          for d in $(ls -1t playwright-reports); do
            if [ -d "playwright-reports/$d" ]; then
              meta="playwright-reports/$d/meta.json"
              if [ -f "$meta" ]; then
                title=$(cat $meta | jq -r '.runId')
                pr=$(cat $meta | jq -r '.prNumber')
                ts=$(cat $meta | jq -r '.timestamp')
                passed=$(cat $meta | jq -r '.passed // empty')
                failed=$(cat $meta | jq -r '.failed // empty')
                skipped=$(cat $meta | jq -r '.skipped // empty')
              else
                title=$d
                pr=""
                ts=""
              fi
              echo "<li><a href=\"playwright-reports/$d/index.html\">$title</a> - PR: $pr - $ts - ${passed:-0} passed/${failed:-0} failed/${skipped:-0} skipped</li>" >> index.html
            fi
          done
          echo "</ul></body></html>" >> index.html
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to gh-pages"
          else
            git commit -m "chore(pages): deploy playwright report and update index"
            git push
          fi

      - name: Comment PR with GitHub Pages report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const prNumber = context.payload.pull_request.number;
            const pagesUrl = `https://${owner}.github.io/${repo}/playwright-reports/${runId}/index.html`;
            const indexUrl = `https://${owner}.github.io/${repo}/playwright-reports/`;
            const body = `:robot: Playwright HTML report published to GitHub Pages: ${pagesUrl}\n\nIndex page: ${indexUrl}`;
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
