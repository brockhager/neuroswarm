name: Neuroswarm Core CI Pipeline

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'bugfix/**'
  pull_request:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    # Set environment variables for the SQLite-backed persistence layer
    env:
      EXPECT_SQLITE: true

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install dependencies (including SQLite build tools)
      run: |
        # Install required packages for better-sqlite3 native module compilation
        sudo apt-get update
        sudo apt-get install -y build-essential
        npm install

    - name: ğŸ§ª Run Unit and Integration Tests (Core Features)
      run: |
        # Core consensus and state tests
        npm test -- tests/unit/
        npm test -- tests/integration/chain.test.mjs
        npm test -- tests/integration/staking.test.mjs

    - name: ğŸ§ª Run Validator Pool (VP) Production Guard Tests
      run: |
        npm test -- tests/integration/producer_selection.test.mjs
        npm test -- tests/integration/vp_production_guard.test.mjs

    # ----------------------------------------------------------------------
    # OPS-03B: Sync Protocol Hardening Tests (CN-05) - All 5 tests added here
    # ----------------------------------------------------------------------
    - name: ğŸ§ª Run Sync Protocol Tests (OPS-03B)
      run: |
        # 1. Ancestry Mismatch Detection
        npm test -- tests/integration/blocks_sync_ancestry.test.mjs
        # 2. Paging/Chunking Enforcement
        npm test -- tests/integration/blocks_sync_paging.test.mjs
        # 3. Rate Limiting (429) and Concurrency Cap
        npm test -- tests/integration/blocks_sync_rate_limit.test.mjs
        # 4. Prometheus Metrics Validation
        npm test -- tests/integration/blocks_sync_metrics.test.mjs
        # 5. Full Sync Roundtrip (Existing test, included for completeness)
        npm test -- tests/integration/blocks_sync_roundtrip.test.mjs

    - name: ğŸ§ª Run Cryptographic E2E Test (CN-01-E2E)
      # This test spins up both VP-Node and NS-Node processes to validate signing/verification.
      run: npm test -- tests/e2e/e2e_crypto_block_propagation.test.mjs

    - name: âš ï¸ Verify database path (CI must use SQLite)
      run: |
        if [ "$EXPECT_SQLITE" != "true" ]; then
          echo "Error: CI environment variable EXPECT_SQLITE is not set to true."
          exit 1
        fi
        echo "âœ… SQLite persistence path confirmed for CI run."